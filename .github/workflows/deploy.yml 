name: Deploy GitHub Pages for Live & Preview

on:
  push:
    branches:
      - live
      - preview

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Pages
      uses: actions/configure-pages@v3

    - name: Build and Deploy
      run: |
        BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///')

        if [ "$BRANCH_NAME" == "live" ]; then
          TARGET_BRANCH="gh-pages"
        elif [ "$BRANCH_NAME" == "preview" ]; then
          TARGET_BRANCH="gh-pages-preview"
        else
          echo "Not deploying, branch is not live or preview"
          exit 0
        fi

        mkdir output
        cp -r * output/
        cd output
        git init
        git checkout -b "$TARGET_BRANCH"
        git add .
        git commit -m "Deploy from $BRANCH_NAME branch"
        git push --force "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" "$TARGET_BRANCH"

    - name: Deploy to GitHub Pages
      uses: actions/deploy-pages@v4
